---
// src/pages/index.astro
export const prerender = false;
---
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TideTrack Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { 
            background: #020617; 
            color: #f8fafc; 
            min-height: 100vh; 
            font-family: ui-sans-serif, system-ui, sans-serif; 
        }
        .glass-card { 
            background: rgba(255, 255, 255, 0.03); 
            backdrop-filter: blur(12px); 
            border: 1px solid rgba(255, 255, 255, 0.1); 
            border-radius: 24px; 
        }
    </style>
</head>
<body class="p-6 md:p-12">
    <div class="max-w-6xl mx-auto">
        <header class="mb-10 flex justify-between items-end">
            <div>
                <h1 class="text-3xl font-bold text-white tracking-tighter">
                    Tide<span class="text-blue-400 font-light">Track</span>
                </h1>
                <p class="text-slate-500 text-xs uppercase tracking-widest mt-1">3-Day Prediction Wave</p>
            </div>
            <div id="clock" class="text-slate-400 font-mono text-sm"></div>
        </header>

        <div id="dashboard-grid" class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <div id="loader" class="col-span-full py-20 text-center text-slate-500 animate-pulse">
                Fetching NOAA Data...
            </div>
        </div>
    </div>

    <script>
        // Plugin to draw the Vertical "Now" Line
        const nowLinePlugin = {
            id: 'nowLine',
            afterDraw: (chart) => {
                const { ctx, chartArea: { top, bottom }, scales: { x } } = chart;
                const now = new Date();
                
                // Find the index of the data point closest to "Now"
                const labels = chart.data.labels;
                let closestIndex = -1;
                let minDiff = Infinity;

                labels.forEach((label, i) => {
                    const diff = Math.abs(new Date(label.replace(/-/g, "/")) - now);
                    if (diff < minDiff) {
                        minDiff = diff;
                        closestIndex = i;
                    }
                });

                if (closestIndex !== -1) {
                    const xPos = x.getPixelForValue(labels[closestIndex]);
                    ctx.save();
                    ctx.beginPath();
                    ctx.setLineDash([5, 5]);
                    ctx.moveTo(xPos, top);
                    ctx.lineTo(xPos, bottom);
                    ctx.lineWidth = 1;
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
                    ctx.stroke();
                    
                    // Draw "NOW" text
                    ctx.fillStyle = 'rgba(255, 255, 255, 0.6)';
                    ctx.font = '10px Arial';
                    ctx.fillText('NOW', xPos - 10, top - 10);
                    ctx.restore();
                }
            }
        };

        async function init() {
            try {
                const res = await fetch('/api/tide-data');
                const data = await res.json();
                const container = document.getElementById('dashboard-grid');
                container.innerHTML = '';

                data.forEach((station, i) => {
                    const div = document.createElement('div');
                    div.className = 'glass-card p-6';
                    div.innerHTML = `
                        <h2 class="text-xl font-bold mb-6">${station.name}</h2>
                        <div class="h-64"><canvas id="c-${i}"></canvas></div>
                    `;
                    container.appendChild(div);

                    const ctx = document.getElementById(`c-${i}`).getContext('2d');
                    const gradient = ctx.createLinearGradient(0, 0, 0, 250);
                    gradient.addColorStop(0, 'rgba(56, 189, 248, 0.4)');
                    gradient.addColorStop(1, 'rgba(56, 189, 248, 0)');

                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: station.predictions.map(p => p.t),