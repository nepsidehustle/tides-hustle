---
// src/pages/index.astro
export const prerender = false;
---
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TideTrack Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { background: #020617; color: #f8fafc; min-height: 100vh; font-family: sans-serif; }
        .glass-card { background: rgba(255, 255, 255, 0.03); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 24px; }
    </style>
</head>
<body class="p-8">
    <div class="max-w-6xl mx-auto">
        <header class="mb-10">
            <h1 class="text-3xl font-bold text-blue-400">TideTrack <span class="text-white font-light text-xl italic">Live Waves</span></h1>
        </header>

        <div id="dashboard-grid" class="grid grid-cols-1 md:grid-cols-2 gap-8 text-center">
            <p id="loading" class="col-span-full py-20 text-slate-500 animate-pulse">Connecting to NOAA sensors...</p>
        </div>
    </div>

    <script>
        async function init() {
            try {
                const res = await fetch('/api/tide-data');
                const data = await res.json();
                const container = document.getElementById('dashboard-grid');
                container.innerHTML = '';

                data.forEach((station, i) => {
                    const div = document.createElement('div');
                    div.className = 'glass-card p-6';
                    div.innerHTML = `
                        <h2 class="text-xl font-bold mb-4 text-left">${station.name}</h2>
                        <div class="h-64"><canvas id="c-${i}"></canvas></div>
                    `;
                    container.appendChild(div);

                    const ctx = document.getElementById(`c-${i}`).getContext('2d');
                    const gradient = ctx.createLinearGradient(0, 0, 0, 250);
                    gradient.addColorStop(0, 'rgba(56, 189, 248, 0.4)');
                    gradient.addColorStop(1, 'rgba(56, 189, 248, 0)');

                    // @ts-ignore
                    new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: station.predictions.map(p => p.t),
                            datasets: [{
                                data: station.predictions.map(p => p.v),
                                borderColor: '#38bdf8',
                                borderWidth: 3,
                                fill: true,
                                backgroundColor: gradient,
                                tension: 0.4,
                                pointRadius: 0
                            }]
                        },
                       options: {
    responsive: true,
    maintainAspectRatio: false,
    plugins: { 
        legend: { display: false },
        tooltip: {
            mode: 'index',
            intersect: false,
            backgroundColor: '#1e293b',
            callbacks: {
                title: (items) => {
                    const d = new Date(items[0].label.replace(/-/g, "/"));
                    return d.toLocaleDateString([], { weekday: 'short', month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                }
            }
        }
    },
    scales: {
        x: { 
            display: true, 
            grid: { display: false },
            ticks: { 
                maxTicksLimit: 8, 
                color: 'rgba(255,255,255,0.4)', 
                font: { size: 10 },
                callback: function(value) {
                    const dateStr = this.getLabelForValue(value);
                    const d = new Date(dateStr.replace(/-/g, "/"));
                    // Shows "Fri 4 PM" or "Sat 10 AM"
                    return d.toLocaleDateString([], { weekday: 'short', hour: 'numeric' });
                }
            }
        },
        y: { 
            grid: { color: 'rgba(255,255,255,0.05)', drawTicks: false },
            ticks: { 
                color: 'rgba(255,255,255,0.4)', 
                font: { size: 10 },
                callback: (value) => value + 'ft'
            }
        }
    }
}
                    });
                });
            } catch (err) {
                console.error("Dashboard error:", err);
            }
        }
        init();
    </script>
</body>
</html>