---
export const prerender = false;
---
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>TideTrack Pro</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-slate-950 text-white p-4 md:p-10">
    <div class="max-w-6xl mx-auto">
        <h1 class="text-3xl font-bold mb-8">Tide<span class="text-blue-400">Track</span> Pro</h1>
        <div id="grid" class="grid grid-cols-1 md:grid-cols-2 gap-6"></div>
    </div>

    <script>
        async function init() {
            const res = await fetch('/api/tide-data');
            const data = await res.json();
            const container = document.getElementById('grid');

            data.forEach((station, i) => {
                const card = document.createElement('div');
                card.className = 'bg-white/5 border border-white/10 p-6 rounded-3xl';
                card.innerHTML = `<h2 class="text-xl font-bold mb-4">${station.name}</h2><div class="h-64"><canvas id="c-${i}"></canvas></div>`;
                container.appendChild(card);

                const pts = station.predictions.map(p => ({
                    // Explanation: We replace the dash with a slash to make iPhones happy
                    x: new Date(p.t.replace(/-/g, "/")).getTime(),
                    y: p.v
                }));

                const vals = pts.map(p => p.y);
                const high = Math.max(...vals);
                const low = Math.min(...vals);

                new Chart(document.getElementById(`c-${i}`), {
                    type: 'line',
                    data: { datasets: [{
                        data: pts,
                        borderColor: '#38bdf8',
                        borderWidth: 3,
                        tension: 0.4,
                        pointRadius: (ctx) => (pts[ctx.dataIndex]?.y === high || pts[ctx.dataIndex]?.y === low) ? 6 : 0,
                        pointBackgroundColor: '#fff',
                        fill: true,
                        backgroundColor: 'rgba(56, 189, 248, 0.1)'
                    }]},
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: {
                                type: 'linear', // THE FIX: Treats the X-axis as a timeline, not just text
                                ticks: {
                                    callback: (val) => {
                                        const d = new Date(val);
                                        return d.toLocaleDateString([], { weekday: 'short', hour: 'numeric' });
                                    },
                                    color: '#64748b'
                                }
                            },
                            y: { 
                                min: Math.floor(low) - 1, 
                                max: Math.ceil(high) + 1,
                                grid: { color: 'rgba(255,255,255,0.05)' } 
                            }
                        }
                    }
                });
            });
        }
        init();
    </script>
</body>
</html>